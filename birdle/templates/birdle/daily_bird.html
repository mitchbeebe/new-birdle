<!-- daily_bird.html -->

{% extends 'birdle/base.html' %}

{% block content %}
<div class="container py-3">
  {% include 'birdle/bird_display.html'%}
  <form method="post" id="guess-form">
    {% csrf_token %}
    <input type="hidden" name="user_id" id="user_id" value="">
    <div class="row justify-content-center mx-auto py-2">
      <div class="col-9 col-lg-6 px-1">
        <input type="text" class="form-control text-center" name="guess-input" id="guess-input" placeholder="Guess">
      </div>
      <div class="col-auto px-1">
        <button type="submit" class="btn btn-primary">Submit</button>
      </div>
    </div>
  </form>

  <div id="guesses" class="col-12 col-lg-6 mx-auto px-3 p-lg-4">
    <div class="row justify-content-center flex-nowrap align-items-end">
      <div class="col-3 taxonomy">Order</div>
      <div class="col-3 taxonomy">Family</div>
      <div class="col-3 taxonomy">Genus</div>
      <div class="col-3 taxonomy">Common Name</div>
    </div>
    {{ guesses_html | safe }}
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  $(document).ready(function () {
    var winner = JSON.parse("{{is_winner}}".toLowerCase());
    winner || {{ guess_count }} == 6 ? showAlert({{guess_count}}, winner, `{{emojis}}`): "";
  });

  $(document).on("submit", "#guess-form", function(e){
    e.preventDefault();
    $("#user_id").val(localStorage.getItem('user_id'));
    var serializedData = $(this).serialize();
    $.ajax({
      type: "POST",
      url: "/",
      data:  serializedData,
      success: function(response){
        $("#guesses").append(response.guesses_html);
        $("#guess-input").val(""); // clear the input field
        response.is_winner || response.guess_count == 6 ? showAlert(response.guess_count, response.is_winner, response.emojis) : "";
      },
      error: function(xhr) {
          // Display the error message in the error message div
          if (xhr.status == 400) {
            $("#guess-input").val(""); // clear the input field
            Swal.fire({
              toast: true,
              title: "That bird doesn't exist!",
              icon: "error",
              showConfirmButton: false,
              timer: 2000,
              timerProgressBar: true
            });
          }
      }
    });
  });

  const pluralize = (count, noun, suffix = 'es') =>
  `${count} ${noun}${count !== 1 ? suffix : ''}`;

  function showAlert(guess_count, is_winner, emojis) {
    const Alert = Swal.mixin({
      title: is_winner ? "Congratulations!" : "Oh no!",
      html: is_winner ? 
      `You got today's Birdle in ${pluralize(guess_count, 'guess')}.<br>Learn more about the <a href=\"{{bird.url}}\" target=_blank>{{bird.name}}</a>.` : 
      "Today's bird was the <a href=\"{{bird.url}}\" target=_blank>{{bird.name}}</a>. But don't fret, <a href='https://birdsarentreal.com/' target=_blank>birds aren't real</a> anyway.",
      icon: is_winner ? "success" : "error",
      confirmButtonText: "Copy Results",
      showDenyButton: true,
      denyButtonText: "Close"
    });

    Alert.fire().then((result) => {
      if (result.isConfirmed) {
        navigator.clipboard.writeText(emojis);
        Swal.fire({
          toast: true,
          title: 'Copied!',
          icon: "success",
          showConfirmButton: false,
          timer: 2000,
          timerProgressBar: true
        })
      }
    });
  };
</script>
{% endblock %}

{% block footer %}
{% include 'birdle/footer.html'%}
{% endblock %}