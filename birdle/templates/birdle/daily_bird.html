<!-- daily_bird.html -->

{% extends 'birdle/base.html' %}
{% load static %}
{% block content %}
<div class="container pt-2">
  {% include 'birdle/bird_display.html'%}
  <form method="post" id="guess-form">
    {% csrf_token %}
    <input type="hidden" name="user_id" id="user_id" value="">
    <input type="hidden" name="hint_used" id="hint_used" value="">
    <div class="row justify-content-center mx-auto py-2 position-relative">
      <div class="col-9 col-lg-6 px-1 position-relative" id="autocomplete-container">
        <input type="text" class="form-control text-center" name="guess-input" id="guess-input" placeholder="Guess"
          tabindex="0"
          autocomplete="off"
          aria-label="Enter bird name guess"
          aria-autocomplete="list"
          aria-controls="suggestions"
          hx-get="{% url 'bird_autocomplete' %}"
          hx-trigger="focus, input changed delay:300ms"
          hx-target="#suggestions"
          hx-vals="js:{...getTaxonomyFilters()}">
        <div id="suggestions" role="listbox" aria-label="Bird suggestions"></div>
      </div>
      <div class="col-auto px-0">
        <button type="submit" class="btn btn-primary" tabindex="0" id="submit-button" aria-label="Submit guess">Submit</button>
      </div>
    </div>
  </form>

  <div id="guesses" class="col-12 col-lg-6 mx-auto px-2 p-lg-4">
    <div class="row justify-content-center flex-nowrap align-items-end">
      <div class="col-3 taxonomy">Order</div>
      <div class="col-3 taxonomy">Family</div>
      <div class="col-3 taxonomy">Genus</div>
      <div class="col-3 taxonomy">Common Name</div>
    </div>
    {% for guess in guesses %}
    <div class="row justify-content-center flex-nowrap align-items-end">
      <div class="col-3 taxonomy guess {{guess.correctness.0}}">{{guess.order}}</div>
      <div class="col-3 taxonomy guess {{guess.correctness.1}}">{{guess.family}}</div>
      <div class="col-3 taxonomy guess {{guess.correctness.2}}">{{guess.genus}}</div>
      <div class="col-3 taxonomy guess {{guess.correctness.3}}">{{guess.name}}</div>
    </div>
    {% endfor %}
  </div>
</div>

<button id="clippy" type="button" class="btn btn-sm btn-light btn-outline-secondary {% if not hint.show %}visually-hidden{% endif %} rounded-circle position-fixed bottom-0 end-0 mb-5 me-2" data-bs-toggle="popover" data-bs-trigger="click" title="{{ hint.title }}" data-bs-content='
<div class="text-center">
<a id="hintBtn" tabindex="0" type="button" class="btn btn-primary btn-sm py-0">Yes</a>
<a id="noBtn" tabindex="0" type="button" class="btn btn-secondary btn-sm py-0">No</a>
</div>
' data-bs-html="true"><img src="{% static 'birdle/clippy.png' %}" class="img-fluid"></button>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="hintToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">Hint</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="hint_msg">
      {{ hint.message }}
    </div>
  </div>
</div>

<br>
<br>
{% endblock %}

{% block extra_scripts %}
<script>
  // Pass Django template data to JavaScript
  window.birdleConfig = {
    isWinner: {{ is_winner|lower }},
    guessCount: {{ guess_count }},
    emojis: `{{ emojis|escapejs }}`,
    bird: {
      name: "{{ bird.name|escapejs }}",
      url: "{{ bird.url|escapejs }}"
    },
    hint: {
      show: {{ hint.show|yesno:"true,false" }},
      title: "{{ hint.title|escapejs }}",
      message: "{{ hint.message|escapejs }}"
    },
    guesses: [
      {% for guess in guesses %}
      {
        order: "{{ guess.order|escapejs }}",
        family: "{{ guess.family|escapejs }}",
        genus: "{{ guess.genus|escapejs }}",
        name: "{{ guess.name|escapejs }}",
        correctness: [
          {{ guess.correctness.0|yesno:"true,false" }},
          {{ guess.correctness.1|yesno:"true,false" }},
          {{ guess.correctness.2|yesno:"true,false" }}
        ]
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  };
</script>
<script src="{% static 'birdle/daily_bird.js' %}"></script>
{% endblock %}

{% block footer %}
{% include 'birdle/footer.html'%}
{% endblock %}
